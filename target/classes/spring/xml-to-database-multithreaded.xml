<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
	http://www.springframework.org/schema/beans/spring-beans-4.0.xsd">
	
	<bean id="converter" class="sellmethis.service.converter.StringBuildConverter" >
	<constructor-arg type="String" > 
	    <value><![CDATA[
            INSERT INTO fias_directions(
				id, code, name, socr, level, is_active, link, parent_link, postal_code
			)
            VALUES(
            	'#<AOID>', 
            	'#<CODE>', 
            	'#<FORMALNAME>', 
            	'#<SHORTNAME>', 
            	'#<AOLEVEL>', 
            	'#<ACTSTATUS>',  
            	'#<AOGUID>',  
            	'#<PARENTGUID>',  
            	NULLIF('#<POSTALCODE>', '')::integer  
        	);
   	    ]]></value>
	</constructor-arg>
	</bean>
	
    <bean id="client" class="sellmethis.service.sender.PgSqlClient" >
		<constructor-arg index="0" type="String" value="127.0.0.1" />
		<constructor-arg index="1" type="int" value="5432"/>
		<constructor-arg index="2" type="String" value="postgres" /> <!-- database -->
		<constructor-arg index="3" type="String" value="postgres" /> <!-- user -->
		<constructor-arg index="4" type="String" value="" />         <!-- password -->
	</bean>
	
    <bean id="sender" class="sellmethis.service.sender.StringSender" >
    	<constructor-arg><ref bean="client"/></constructor-arg>
	</bean>  
	
    <bean id="builder" class="sellmethis.service.sender.ThreadSenderBuilder" >
    	<constructor-arg><ref bean="sender"/></constructor-arg>
	</bean>   
	
	<bean id="buffer" class="sellmethis.service.sender.PayloadStringBuffer" />
	
    <bean id="proxy-sender-on-start" class="sellmethis.service.sender.MultithreadedProxySender" >
    	<constructor-arg index="0" ><ref bean="builder"/></constructor-arg>
    	<constructor-arg index="1" ><ref bean="buffer"/></constructor-arg>
    	<constructor-arg index="2" type="int" value="100" /> <!-- max buffer records -->
    	<constructor-arg index="3" type="int" value="10" /> <!-- max threads -->
	</bean>  
	
	<!-- process the rest of the buffer -->
    <bean id="proxy-sender-on-end" class="sellmethis.service.sender.MultithreadedProxySender" >
    	<constructor-arg index="0" ><ref bean="builder"/></constructor-arg>
    	<constructor-arg index="1" ><ref bean="buffer"/></constructor-arg>
    	<constructor-arg index="2" type="int" value="1" /> <!-- max buffer records -->
    	<constructor-arg index="3" type="int" value="1" /> <!-- max threads -->
	</bean>  
		
    <bean id="service-on-start" class="sellmethis.service.PrepareAndSendService" > 
    	<constructor-arg index="0" ><ref bean="converter"/></constructor-arg>
    	<constructor-arg index="1" ><ref bean="proxy-sender-on-start"/></constructor-arg>
    	<constructor-arg index="2" >
    		<array><value>Object</value></array>
		</constructor-arg>
	</bean>  
	
    <bean id="service-on-end" class="sellmethis.service.PrepareAndSendService" >
    	<constructor-arg index="0" ><ref bean="converter"/></constructor-arg>
    	<constructor-arg index="1" ><ref bean="proxy-sender-on-end"/></constructor-arg>
    	<constructor-arg index="2" >
    		<array><value>AddressObjects</value></array>
		</constructor-arg>
	</bean>
	
    <bean id="handler" class="sellmethis.ParseHandler" >
    	<constructor-arg index="0" ><ref bean="service-on-start"/></constructor-arg>
    	<constructor-arg index="1" ><ref bean="service-on-end"/></constructor-arg>
	</bean>    	
</beans>
